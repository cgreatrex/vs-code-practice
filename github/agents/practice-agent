#!/usr/bin/env python3
"""
GitHub Repository Structure Agent
Helps analyze and organize your GitHub repository structure
"""

import os
import json
import sys
import tempfile
import subprocess
from pathlib import Path
from collections import defaultdict
from urllib.parse import urlparse


class RepoStructureAgent:
    """Agent for analyzing GitHub repository organization"""

    def __init__(self, repo_path="."):
        self.repo_path = Path(repo_path)
        self.ignore_patterns = {
            '.git', 'node_modules', '.venv', '__pycache__', 
            '.pytest_cache', 'dist', 'build', '.DS_Store'
        }
        self.file_categories = defaultdict(list)
        self.is_remote = False

    @staticmethod
    def is_github_url(path):
        """Check if path is a GitHub URL"""
        return path.startswith('http') and 'github.com' in path

    @staticmethod
    def clone_github_repo(github_url):
        """Clone a GitHub repo to a temporary directory"""
        try:
            with tempfile.TemporaryDirectory() as tmpdir:
                print(f"ğŸ“¥ Cloning repository: {github_url}")
                subprocess.run(
                    ['git', 'clone', '--depth', '1', github_url, tmpdir],
                    capture_output=True,
                    check=True,
                    timeout=60
                )
                return tmpdir
        except subprocess.CalledProcessError as e:
            print(f"âŒ Failed to clone repository: {e.stderr.decode()}")
            return None
        except Exception as e:
            print(f"âŒ Error cloning repository: {e}")
            return None

    @classmethod
    def from_github_url(cls, github_url):
        """Create an agent from a GitHub URL"""
        tmpdir = cls.clone_github_repo(github_url)
        if tmpdir:
            agent = cls(tmpdir)
            agent.is_remote = True
            return agent
        return None

    def analyze(self):
        """Scan and categorize all files in the repo"""
        print(f"ğŸ” Analyzing repository: {self.repo_path}")
        
        for root, dirs, files in os.walk(self.repo_path):
            # Skip ignored directories
            dirs[:] = [d for d in dirs if d not in self.ignore_patterns]
            
            for file in files:
                filepath = Path(root) / file
                self._categorize_file(filepath)
        
        report = self._generate_report()
        self._print_report(report)
        return report

    def _categorize_file(self, filepath):
        """Categorize a file by its type"""
        suffix = filepath.suffix.lower()
        name = filepath.name
        
        if suffix == '.py':
            category = 'ğŸ Python'
        elif suffix in ['.js', '.ts']:
            category = 'ğŸ“œ JavaScript/TypeScript'
        elif suffix in ['.md', '.txt', '.rst']:
            category = 'ğŸ“š Documentation'
        elif name in ['package.json', '.gitignore', 'requirements.txt', 'setup.py', 'Makefile']:
            category = 'âš™ï¸  Config/Build'
        elif suffix in ['.png', '.jpg', '.svg', '.ico']:
            category = 'ğŸ–¼ï¸  Images'
        else:
            category = 'ğŸ“¦ Other'
        
        self.file_categories[category].append(str(filepath.relative_to(self.repo_path)))

    def _generate_report(self):
        """Create the analysis report"""
        return {
            'total_files': sum(len(v) for v in self.file_categories.values()),
            'categories': dict(self.file_categories),
            'suggestions': self._get_suggestions()
        }

    def _print_report(self, report):
        """Print a formatted report"""
        print("\n" + "="*50)
        print("ğŸ“Š REPO STRUCTURE ANALYSIS")
        print("="*50)
        print(f"\nğŸ“ˆ Total Files Found: {report['total_files']}\n")
        
        print("ğŸ“‚ Files by Category:")
        for category, files in sorted(report['categories'].items()):
            print(f"  {category}: {len(files)} files")
        
        print("\nğŸ’¡ Suggestions:")
        for suggestion in report['suggestions']:
            print(f"  â€¢ {suggestion}")
        print("\n" + "="*50 + "\n")

    def _get_suggestions(self):
        """Generate improvement suggestions based on analysis"""
        suggestions = []
        
        python_files = len(self.file_categories.get('ğŸ Python', []))
        if python_files > 10:
            suggestions.append("Consider creating a 'src/' directory for Python files")
        
        docs = len(self.file_categories.get('ğŸ“š Documentation', []))
        if docs > 3:
            suggestions.append("Consider organizing docs into a 'docs/' directory")
        
        if not any('test' in f.lower() for files in self.file_categories.values() for f in files):
            suggestions.append("Add a 'tests/' directory with test files")
        
        return suggestions or ["âœ… Repository structure looks good!"]


if __name__ == "__main__":
    repo_path = "."
    
    # Check for command-line arguments
    if len(sys.argv) > 1:
        repo_path = sys.argv[1]
    
    # Check if it's a GitHub URL
    if RepoStructureAgent.is_github_url(repo_path):
        print(f"ğŸŒ Detected GitHub URL: {repo_path}")
        agent = RepoStructureAgent.from_github_url(repo_path)
        if agent:
            agent.analyze()
        else:
            print("âŒ Failed to analyze remote repository")
            sys.exit(1)
    else:
        agent = RepoStructureAgent(repo_path)
        agent.analyze()
